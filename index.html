<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>エクサスケイル防具 回路シミュレーター</title>
<style>
body {
  font-family: monospace;
  padding: 20px;
  max-width: 1200px;
  margin: auto;
  background: #fff;
  color: #000;
  text-align: center;
}

h2 { margin-bottom: 16px; }

.container {
  display: flex;
  gap: 30px;
  justify-content: center;
  align-items: stretch;
}

.left-frame, .side {
  background: #f5f5f5;
  padding: 16px;
  border-radius: 10px;
  border: 2px solid #333;
  box-shadow: 4px 4px 10px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
}

.side {
  max-width: 350px;
  width: 350px;
  box-sizing: border-box;
}

.left-frame {
  display: grid;
  grid-template-columns: repeat(2, auto);
  gap: 12px;
}

.board-wrap {
  text-align: center;
  background: #f5f5f5;
  padding: 12px;
  border-radius: 10px;
}

.board {
  display: grid;
  grid-template-columns: repeat(4, 56px);
  grid-template-rows: repeat(4, 56px);
  gap: 2px;
  padding: 2px;
  background: #e0e0e0;
  border-radius: 0px;
}

.cell {
  position: relative;
  border: 1px solid #333;
  font-size: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  user-select: none;
  background: #fff;
  border-radius: 4px;
}

.symbol-display {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.number-display {
  position: absolute;
  bottom: 2px;
  right: 2px;
  font-size: 11px;
  color: #000;
}

.connected { font-weight: bold; }

.highlight-red { background: #ffe8e8; color: #c00; }
.highlight-blue { background: #e8f1ff; color: #246bff; }
.highlight-green { background: #e6fffa; color: #0a8; }

.panel { display: flex; gap: 6px; justify-content: center; margin-bottom: 6px; }

.palette {
  display: flex;
  gap: 20px;
  margin-top: 10px;
  align-items: flex-start;
  justify-content: center;
}

.column, .multi-column {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
}

.symbol {
  width: 48px;
  height: 48px;
  border: 1px solid #333;
  font-size: 26px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  user-select: none;
}

.multi-label {
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 11px;
  font-weight: bold;
  color: #000;
}

.symbol.selected { background: #007bff; color: #fff; }
.symbol.multi { width: 46px; height: 46px; font-size: 32px; border: 2px dashed #333; }
.delete-btn { margin-top: 58px; }

.multi-title {
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 4px;
  text-align: center;
  height: 20px;
  line-height: 1.5;
}

.slot-buttons div {
  margin-bottom: 6px;
  display: flex;
  align-items: stretch;
  justify-content: center;
  gap: 4px;
}

.slot-name {
  max-width: 180px;
  height: 28px;
  box-sizing: border-box;

  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.slot-buttons button { height: 28px; box-sizing: border-box; }

h3 { text-align: left; margin-bottom: 4px; }

#numRadio label { margin-right: 6px; }

#changelog {
  position: relative;
  margin-top: 12px;
  width: 100%;
  height: 70px;
  background: #fefefe;
  border: 2px solid #333;
  border-radius: 4px;
  padding: 10px;
  font-family: monospace;
  font-size: 12px;
  overflow-y: auto;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
  box-sizing: border-box;
}

#changelog h4 { margin: 0 0 6px 0; font-size: 14px; text-align: left; }
#changelog ul { padding-left: 6px; margin: 0; list-style: none; text-align: left; }
#changelog li { margin-bottom: 4px; }
</style>
</head>
<body>

<h2>エクサスケイル防具 回路シミュレーター v1.4</h2>

<div class="container">

  <div class="left-frame" id="boards"></div>

  <div class="side">

    <div class="palette">

      <div class="column">
        <div class="multi-title">増幅回路</div>
        <div class="symbol">┃</div>
        <div class="symbol">━</div>
        <div class="symbol delete-btn">削</div>
      </div>

      <div class="column">
        <div class="multi-title" style="visibility:hidden;">タイトル</div>
        <div class="symbol">┗</div>
        <div class="symbol">┏</div>
        <div class="symbol">┓</div>
        <div class="symbol">┛</div>
      </div>

      <div class="column">
        <div class="multi-title" style="visibility:hidden;">タイトル</div>
        <div class="symbol">┳</div>
        <div class="symbol">┫</div>
        <div class="symbol">┻</div>
        <div class="symbol">┣</div>
      </div>

      <div class="column multi-column">
        <div class="multi-title">複製回路</div>
        <div class="symbol multi">┳</div>
        <div class="symbol multi">┫</div>
        <div class="symbol multi">┻</div>
        <div class="symbol multi">┣</div>
      </div>

    </div> <!-- /.palette -->

    <h3>数値選択</h3>
    <div id="numRadio" style="display: flex; flex-direction: column; align-items: flex-start;">
      
      <div>
        <label><input type="radio" name="num" value="0">0</label>
      </div>
      
      <div style="margin-top: 4px;">
        <label><input type="radio" name="num" value="0.5" checked>0.5</label>
        <label><input type="radio" name="num" value="0.6">0.6</label>
        <label><input type="radio" name="num" value="0.7">0.7</label>
        <label><input type="radio" name="num" value="0.8">0.8</label>
        <label><input type="radio" name="num" value="0.9">0.9</label>
        <label><input type="radio" name="num" value="1.0">1.0</label>
      </div>

    </div> <!-- /#numRadio -->

    <h3>セーブ</h3>
    <div class="slot-buttons">

      <div>
        <input type="text" class="slot-name" value="スロット1">
        <button class="saveBtn" data-slot="1">保存</button>
        <button class="loadBtn" data-slot="1">読み込み</button>
      </div>

      <div>
        <input type="text" class="slot-name" value="スロット2">
        <button class="saveBtn" data-slot="2">保存</button>
        <button class="loadBtn" data-slot="2">読み込み</button>
      </div>

      <div>
        <input type="text" class="slot-name" value="スロット3">
        <button class="saveBtn" data-slot="3">保存</button>
        <button class="loadBtn" data-slot="3">読み込み</button>
      </div>
      
      <div>
        <input type="text" class="slot-name" value="スロット4">
        <button class="saveBtn" data-slot="4">保存</button>
        <button class="loadBtn" data-slot="4">読み込み</button>
      </div>
      
      <div>
        <input type="text" class="slot-name" value="スロット5">
        <button class="saveBtn" data-slot="5">保存</button>
        <button class="loadBtn" data-slot="5">読み込み</button>
      </div>
    </div> <!-- /.slot-buttons -->

    <div id="changelog">
      <h4>更新履歴</h4>
      <ul id="changelogList">
        <li>v1.4：回路修正 + その他調整</li>
        <li>v1.3：セーブスロット機能追加 + その他調整</li>
        <li>v1.2：ローカル保存機能追加 + その他調整</li>
        <li>v1.1：部位・数値・複製回路機能追加</li>
        <li>v1.0：シミュ仮公開</li>
      </ul>
    </div> <!-- /#changelog -->

  </div> <!-- /.side -->

</div> <!-- /.container -->

<script>
/* ============================== */
const size = 4;
let selected = "";
let selectedNumber = "0.5";
let selectedIsMulti = false;
const boards = [];
const connections = {
  "━":{l:1,r:1,u:0,d:0}, "┃":{l:0,r:0,u:1,d:1},
  "┗":{l:0,r:1,u:1,d:0}, "┏":{l:0,r:1,u:0,d:1},
  "┓":{l:1,r:0,u:0,d:1}, "┛":{l:1,r:0,u:1,d:0},
  "┳":{l:1,r:1,u:0,d:1}, "┻":{l:1,r:1,u:1,d:0},
  "┣":{l:0,r:1,u:1,d:1}, "┫":{l:1,r:0,u:1,d:1}
};
const partPos = { top:[3,3], bottom:[0,3], glove:[3,0], shoes:[0,0] };
const boardsEl = document.getElementById("boards");

// ================== 選択管理 ==================
document.querySelectorAll(".symbol").forEach(s=>{
  s.onclick = () => {
    document.querySelectorAll(".symbol").forEach(x=>x.classList.remove("selected"));
    s.classList.add("selected");
    selected = s.textContent;
    selectedIsMulti = s.classList.contains("multi");
  };
});

document.querySelectorAll('input[name="num"]').forEach(r=>{
  r.onchange = ()=> selectedNumber = r.value;
});

// ================== ボード初期化 ==================
const initialParts = ["top","bottom","glove","shoes"];
let savedData = JSON.parse(localStorage.getItem("circuitBoards") || "null") || null;

for(let i=0;i<4;i++){
  const wrap = document.createElement("div");
  wrap.className="board-wrap";
  const panel = document.createElement("div"); panel.className="panel";
  panel.innerHTML=`
    <select class="color">
      <option value="red">赤</option>
      <option value="blue">青</option>
      <option value="green">緑</option>
    </select>
    <select class="part">
      <option value="top">上衣</option>
      <option value="bottom">下衣</option>
      <option value="glove">手袋</option>
      <option value="shoes">靴</option>
    </select>
  `;
  wrap.appendChild(panel);

  const clearBtn = document.createElement("button");
  clearBtn.textContent = "回路クリア"; clearBtn.className="clear-board-btn";
  panel.appendChild(clearBtn);

  const board = document.createElement("div"); board.className="board"; wrap.appendChild(board);
  const sumDiv = document.createElement("div"); sumDiv.style.marginTop="6px"; sumDiv.style.fontWeight="bold";
  sumDiv.textContent="接続済み合計: 0"; wrap.appendChild(sumDiv);

  const grid = Array.from({length:4},()=>Array(4).fill(null).map(()=>({symbol:"",number:"",multi:false})));
  let part = savedData?.[i]?.part || initialParts[i];
  const [px, py] = partPos[part];
  grid[py][px] = {symbol:"◯", number:"", multi:false};
  panel.querySelector(".part").value = part;
  panel.querySelector(".color").value = savedData?.[i]?.color || "red";
  
  // 保存データ読み込み
  if(savedData?.[i]?.grid){
    for(let y=0;y<4;y++) for(let x=0;x<4;x++)
      if(savedData[i].grid[y][x].symbol!=="◯") grid[y][x] = {...savedData[i].grid[y][x]};
  }

  // ================ イベント ==================
  panel.querySelector(".part").onchange = () => {
    const p = panel.querySelector(".part").value;
    for(let y=0;y<4;y++) for(let x=0;x<4;x++) if(grid[y][x].symbol==="◯") grid[y][x].symbol="";
    const [x,y] = partPos[p]; grid[y][x] = {symbol:"◯",number:"",multi:false};
    drawBoard(); saveBoards();
  };
  panel.querySelector(".color").onchange = ()=>{ drawBoard(); saveBoards(); };
  clearBtn.onclick = ()=> {
    if(confirm("回路を全て削除しますか？")){
      for(let y=0;y<4;y++) for(let x=0;x<4;x++) if(grid[y][x].symbol!=="◯") grid[y][x]={symbol:"",number:"",multi:false};
      drawBoard(); saveBoards();
    }
  };

  for(let y=0;y<4;y++) for(let x=0;x<4;x++){
    const c = document.createElement("div"); c.className="cell";
    c.onclick = ()=>{
      const cell = grid[y][x];
      if(cell.symbol==="◯") return;
      if(selected==="削") grid[y][x]={symbol:"",number:"",multi:false};
      else if(selected) grid[y][x]={symbol:selected, number:selectedIsMulti?"":selectedNumber, multi:selectedIsMulti};
      drawBoard(); saveBoards();
    };
    board.appendChild(c);
  }

  function drawBoard(){
    board.querySelectorAll(".cell").forEach((c,i)=>{
      const y=Math.floor(i/4), x=i%4, s=grid[y][x];
      c.innerHTML =
        `<div class="symbol-display">${s.symbol}</div>
        ${s.multi ? '<div class="multi-label">複</div>' : ''}
        <div class="number-display">${s.number||""}</div>`;

      c.className="cell"; if(s.multi) c.classList.add("multi-cell");
    });
    updateBoard();
  }

  function updateBoard(){
    const dx={l:-1,r:1,u:0,d:0}, dy={l:0,r:0,u:-1,d:1}, opp={l:"r",r:"l",u:"d",d:"u"};

   let cx=-1, cy=-1;
   for(let y=0;y<4;y++) for(let x=0;x<4;x++){
     if(grid[y][x].symbol==="◯"){ cx=x; cy=y; }
   }
    if(cx===-1) return;

    const visited = Array.from({length:4},()=>Array(4).fill(false));
    const stack = [[cx,cy]];
    visited[cy][cx]=true;

  let invalid = false;

    while(stack.length && !invalid){
      const [x,y] = stack.pop();
      const s = grid[y][x];

     for(const d in dx){
     const nx = x + dx[d], ny = y + dy[d];

      if (connections[s.symbol]?.[d]) {
       if (ny < 0 || ny >= 4 || nx < 0 || nx >= 4) {
           invalid = true;
           break;
        }
       }

      const t = grid[ny]?.[nx];
       if (!t) continue;
        if(s.symbol==="◯"){
          if(t.symbol && connections[t.symbol]){
           if(!connections[t.symbol]?.[opp[d]]){
              invalid = true;
             break;
           }
            if(!visited[ny][nx]){
              visited[ny][nx]=true;
              stack.push([nx,ny]);
            }
          }
          continue;
        }

       if(connections[s.symbol]?.[d]){
         if(!t.symbol){
            invalid = true; break;
          }
          if(t.symbol==="◯"){
            if(!visited[ny][nx]){
              visited[ny][nx]=true;
              stack.push([nx,ny]);
            }
          } else {
           if(!connections[t.symbol]?.[opp[d]]){
             invalid = true; break;
            }
            if(!visited[ny][nx]){
              visited[ny][nx]=true;
              stack.push([nx,ny]);
           }
         }
        }
      }
    }

   if(invalid){
      board.querySelectorAll(".cell").forEach(c=>c.className="cell");
      sumDiv.textContent="接続済み合計: 0";
      return;
    }

    const color = panel.querySelector(".color").value;
    let sum = 0;

   board.querySelectorAll(".cell").forEach((c,i)=>{
     const y=Math.floor(i/4), x=i%4, s=grid[y][x];
     c.className="cell";
     if(!visited[y][x]) return;

     if(s.multi){
       let sumHalf=0;
       for(const d in dx){
         const nx=x+dx[d], ny=y+dy[d], t=grid[ny]?.[nx];
         if(t && visited[ny][nx] && !t.multi && t.number){
            if(connections[s.symbol]?.[d] && connections[t.symbol]?.[opp[d]]){
             sumHalf += parseFloat(t.number)/2;
            }
          }
        }
       c.querySelector(".number-display").textContent =
         sumHalf ? sumHalf.toFixed(2) : "";
       sum += sumHalf;
      } else {
        const n=parseFloat(s.number);
        if(!isNaN(n)) sum+=n;
     }

      if(connections[s.symbol]){
       c.classList.add("connected","highlight-"+color);
      }
    });

    sumDiv.textContent="接続済み合計: "+sum.toFixed(2);
  }


  function clearBoard(){ board.querySelectorAll(".cell").forEach(c=>c.className="cell"); }

  wrap.drawBoard = drawBoard;
  wrap.grid = grid;
  wrap.panel = panel;
  boards.push(wrap);
  boardsEl.appendChild(wrap);
  drawBoard();
}

// ================== ローカル保存 ==================
function saveBoards(){
  const data = boards.map(b=>({
    grid: b.grid.map(r=>r.map(c=>({symbol:c.symbol||"",number:c.number||"",multi:!!c.multi}))),
    color: b.panel.querySelector(".color").value||"red",
    part: b.panel.querySelector(".part").value||"top"
  }));
  localStorage.setItem("circuitBoards", JSON.stringify(data));
}

// ================== 更新履歴 ==================
function addChangelog(text){
  const ul=document.getElementById("changelogList");
  const li=document.createElement("li"); li.textContent=text; ul.prepend(li);
}

// ================== セーブスロット ==================
document.querySelectorAll(".slot-buttons div").forEach((slotDiv,index)=>{
  const slot=index+1;
  const storedName=localStorage.getItem("circuitBoards_slot"+slot+"_name");
  if(storedName) slotDiv.querySelector(".slot-name").value=storedName;
});

document.querySelectorAll(".saveBtn").forEach(btn=>{
  btn.onclick=()=>{
    const slot=btn.dataset.slot;
    const slotDiv=btn.parentElement;
    const slotName=slotDiv.querySelector(".slot-name").value||"スロット"+slot;
    try{
      const saveData = boards.map(b=>({
        grid:b.grid.map(r=>r.map(c=>({symbol:c.symbol||"",number:c.number||"",multi:!!c.multi}))),
        color:b.panel.querySelector(".color").value||"red",
        part:b.panel.querySelector(".part").value||"top"
      }));
      localStorage.setItem("circuitBoards_slot"+slot, JSON.stringify(saveData));
      localStorage.setItem("circuitBoards_slot"+slot+"_name", slotName);
      addChangelog(slotName+" に保存しました: "+new Date().toLocaleString());
    }catch(e){ alert("保存に失敗しました: "+e.message); console.error(e); }
  };
});

document.querySelectorAll(".loadBtn").forEach(btn=>{
  btn.onclick=()=>{
    const slot=btn.dataset.slot;
    const data=localStorage.getItem("circuitBoards_slot"+slot);
    const slotName=localStorage.getItem("circuitBoards_slot"+slot+"_name")||("スロット"+slot);
    if(!data){ alert(slotName+" は空です"); return; }
    try{
      const parsed=JSON.parse(data);
      parsed.forEach((d,i)=>{
        for(let y=0;y<4;y++) for(let x=0;x<4;x++)
          boards[i].grid[y][x]={...d.grid[y][x]};
        boards[i].panel.querySelector(".color").value=d.color||"red";
        boards[i].panel.querySelector(".part").value=d.part||"top";
        boards[i].drawBoard();
      });
      addChangelog(slotName+" から読み込みました: "+new Date().toLocaleString());
    }catch(e){ alert(slotName+" のデータが壊れています: "+e.message); console.error(e); }
  };
});
</script>

</body>
</html>


