<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>回路シミュ</title>

<style>
body {
  font-family: monospace;
  padding: 20px;
  max-width: 1100px;
  margin: auto;
  background: #ffffff;
  color: #000;
}

.container {
  display: flex;
  gap: 30px;
}

/* ===== 盤面エリア ===== */
.boards {
  display: grid;
  grid-template-columns: repeat(2, auto);
  gap: 30px;
}

/* 左の4マスの枠 */
.left-frame {
  background: #f5f5f5;
  padding: 12px;
  border-radius: 10px;
  display: grid;
  grid-template-columns: repeat(2, auto);
  gap: 12px;
}

/* 右の盤面と左のまとめ枠を統一 */
.board-wrap {
  text-align: center;
  background: #f5f5f5;
  padding: 12px;
  border-radius: 10px;
}

/* 盤面 */
.board {
  display: grid;
  grid-template-columns: repeat(4, 56px);
  grid-template-rows: repeat(4, 56px);
  gap: 2px;
  padding: 4px;
  background: #e0e0e0;
  border-radius: 8px;
}

/* マス */
.cell {
  border: 1px solid #333;
  font-size: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  user-select: none;
  background: #fff;
  border-radius: 6px;
}

.connected {
  font-weight: bold;
}

.highlight-red { background: #ffe8e8; color: #c00; }
.highlight-blue { background: #e8f1ff; color: #246bff; }
.highlight-green { background: #e6fffa; color: #0a8; }

/* パネル */
.panel {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-bottom: 6px;
}

.palette {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.column {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.symbol {
  width: 48px;
  height: 48px;
  border: 1px solid #333;
  font-size: 26px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  user-select: none;
}

.symbol.selected {
  background: #007bff;
  color: #fff;
}

/* 右側のパネル */
.side {
  min-width: 220px;
  border: 1px solid #333;
  padding: 10px;
  background: #f5f5f5;
  border-radius: 10px;
}

textarea {
  width: 100%;
  height: 120px;
  font-family: monospace;
  background: #fff;
  color: #000;
  border: 1px solid #333;
}

button {
  cursor: pointer;
  margin-bottom: 6px;
}
</style>
</head>
<body>

<h2>回路シミュ</h2>

<div class="container">
  <div class="left-frame" id="boards"></div>

  <div class="side">
    <h3>罫線</h3>
    <div class="palette">
      <div class="column">
        <div class="symbol">━</div>
        <div class="symbol">┃</div>
        <div class="symbol">⌫</div>
      </div>
      <div class="column">
        <div class="symbol">┗</div>
        <div class="symbol">┏</div>
        <div class="symbol">┓</div>
        <div class="symbol">┛</div>
      </div>
      <div class="column">
        <div class="symbol">┳</div>
        <div class="symbol">┫</div>
        <div class="symbol">┻</div>
        <div class="symbol">┣</div>
      </div>
    </div>

    <h3>保存</h3>
    <button id="exportBtn">エクスポート</button>
    <button id="importBtn">インポート</button>
    <textarea id="data"></textarea>
  </div>
</div>

<script>
const size = 4;
let selected = "";
const boards = [];
const dataEl = document.getElementById("data");

const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");

const connections = {
  "━":{l:1,r:1,u:0,d:0},"┃":{l:0,r:0,u:1,d:1},
  "┗":{l:0,r:1,u:1,d:0},"┏":{l:0,r:1,u:0,d:1},
  "┓":{l:1,r:0,u:0,d:1},"┛":{l:1,r:0,u:1,d:0},
  "┳":{l:1,r:1,u:0,d:1},"┻":{l:1,r:1,u:1,d:0},
  "┣":{l:0,r:1,u:1,d:1},"┫":{l:1,r:0,u:1,d:1}
};

const partPos = {top:[3,3], bottom:[0,3], glove:[3,0], shoes:[0,0]};

// パレット選択
document.querySelectorAll(".symbol").forEach(s=>{
  s.onclick=()=>{
    document.querySelectorAll(".symbol").forEach(x=>x.classList.remove("selected"));
    s.classList.add("selected");
    selected=s.textContent;
  };
});

const boardsEl=document.getElementById("boards");

// 4つの盤面生成（左のまとめ枠内）
for(let i=0;i<4;i++){
  const wrap=document.createElement("div");
  wrap.className="board-wrap";

  const panel=document.createElement("div");
  panel.className="panel";
  panel.innerHTML=`
    <select class="color">
      <option value="red">赤</option>
      <option value="blue">青</option>
      <option value="green">緑</option>
    </select>
    <select class="part">
      <option value="">---</option>
      <option value="top">上衣</option>
      <option value="bottom">下衣</option>
      <option value="glove">手袋</option>
      <option value="shoes">靴</option>
    </select>
  `;
  wrap.appendChild(panel);

  const board=document.createElement("div");
  board.className="board";
  wrap.appendChild(board);

  const grid=Array.from({length:4},()=>Array(4).fill(""));

  panel.querySelector(".part").onchange=()=>{grid.forEach(r=>r.fill("")); const p=panel.querySelector(".part").value; if(p){const [x,y]=partPos[p];grid[y][x]="◯";} draw();}
  panel.querySelector(".color").onchange=()=>draw();

  function draw(){
    board.querySelectorAll(".cell").forEach((c,i)=>{const y=Math.floor(i/4),x=i%4;c.textContent=grid[y][x];});
    update();
  }

  for(let y=0;y<4;y++) for(let x=0;x<4;x++){
    const c=document.createElement("div");
    c.className="cell";
    c.onclick = () => {
  if (!selected) return;
  // ◯は何でも上書きできない
  if (grid[y][x] === "◯") return;
  grid[y][x] = selected === "⌫" ? "" : selected;
  draw();
};
    board.appendChild(c);
  }

  function update(){
    let hasLine=false,circle=false;
    const dx={l:-1,r:1,u:0,d:0}, dy={l:0,r:0,u:-1,d:1}, opp={l:"r",r:"l",u:"d",d:"u"};

    for(let y=0;y<4;y++) for(let x=0;x<4;x++){
      const s=grid[y][x]; if(!s) continue;
      if(s!=="◯") hasLine=true;
      if(s==="◯"){for(const d in dx){const nx=x+dx[d], ny=y+dy[d]; if(grid[ny]?.[nx] && grid[ny][nx]!=="◯") circle=true;} continue;}
      for(const d in connections[s]){if(!connections[s][d]) continue; const nx=x+dx[d], ny=y+dy[d]; const t=grid[ny]?.[nx]; if(!t) return clear(); if(t==="◯"){circle=true;continue;} if(!connections[t][opp[d]]) return clear();}
    }

    const color=panel.querySelector(".color").value;
    board.querySelectorAll(".cell").forEach((c,i)=>{const y=Math.floor(i/4),x=i%4;c.className="cell"; if(hasLine&&circle&&grid[y][x]) c.classList.add("connected","highlight-"+color);});
  }

  function clear(){board.querySelectorAll(".cell").forEach(c=>c.className="cell");}

  boards.push({grid,panel,draw});
  boardsEl.appendChild(wrap);
}

// エクスポート
exportBtn.onclick=()=>{
  dataEl.value=JSON.stringify(
    boards.map(b=>({grid:b.grid,color:b.panel.querySelector(".color").value,part:b.panel.querySelector(".part").value})), null, 2
  );
};

// インポート
importBtn.onclick=()=>{
  try{
    const data=JSON.parse(dataEl.value);
    data.forEach((d,i)=>{
      boards[i].grid=d.grid;
      boards[i].panel.querySelector(".color").value=d.color;
      boards[i].panel.querySelector(".part").value=d.part;
      boards[i].draw();
    });
  } catch{ alert("データ形式が不正です"); }
};
</script>
</body>
</html>