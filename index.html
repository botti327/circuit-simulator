<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>回路シミュ</title>
<style>
body { font-family: monospace; padding: 20px; max-width: 1200px; margin: auto; background:#fff; color:#000; }
.container { display:flex; gap:30px; }
.left-frame { background:#f5f5f5; padding:16px; border-radius:10px; display:grid; grid-template-columns:repeat(2,auto); gap:12px; border:2px solid #333; box-shadow:2px 2px 6px rgba(0,0,0,0.2);}
.side { min-width:280px; border:2px solid #333; padding:16px; background:#f5f5f5; border-radius:10px; box-shadow:2px 2px 6px rgba(0,0,0,0.2);}
.board-wrap { text-align:center; background:#f5f5f5; padding:12px; border-radius:10px;}
.board { display:grid; grid-template-columns:repeat(4,56px); grid-template-rows:repeat(4,56px); gap:2px; padding:4px; background:#e0e0e0; border-radius:8px;}
.cell { position:relative; border:1px solid #333; font-size:50px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; background:#fff; border-radius:6px;}
.symbol-display { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);}
.number-display { position:absolute; bottom:2px; right:2px; font-size:16px; color:#000;}
.connected { font-weight:bold;}
.highlight-red { background:#ffe8e8; color:#c00;}
.highlight-blue { background:#e8f1ff; color:#246bff;}
.highlight-green { background:#e6fffa; color:#0a8;}
.panel { display:flex; gap:6px; justify-content:center; margin-bottom:6px;}
.palette { display:flex; gap:10px; margin-top:10px;}
.column { display:flex; flex-direction:column; gap:8px;}
.symbol { width:48px; height:48px; border:1px solid #333; font-size:26px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;}
.symbol.selected { background:#007bff; color:#fff;}
.symbol.multi { border:2px dashed #333; }
textarea { width:100%; height:120px; font-family:monospace; background:#fff; color:#000; border:1px solid #333;}
button { cursor:pointer; margin-bottom:6px;}
</style>
</head>
<body>

<h2>回路シミュ</h2>

<div class="container">
  <div class="left-frame" id="boards"></div>

  <div class="side">
    <h3>回路選択</h3>
    <div class="palette">
      <div class="column">
        <div class="symbol">━</div>
        <div class="symbol">┃</div>
        <div class="symbol">⌫</div>
      </div>
      <div class="column">
        <div class="symbol">┗</div>
        <div class="symbol">┏</div>
        <div class="symbol">┓</div>
        <div class="symbol">┛</div>
      </div>
      <div class="column">
        <div class="symbol">┳</div>
        <div class="symbol">┫</div>
        <div class="symbol">┻</div>
        <div class="symbol">┣</div>
      </div>
      <div class="column">
        <div class="symbol multi">┳</div>
        <div class="symbol multi">┫</div>
        <div class="symbol multi">┻</div>
        <div class="symbol multi">┣</div>
      </div>
    </div>

    <h3>数字選択</h3>
    <div id="numRadio">
      <label><input type="radio" name="num" value="0.5" checked>0.5</label>
      <label><input type="radio" name="num" value="0.6">0.6</label>
      <label><input type="radio" name="num" value="0.7">0.7</label>
      <label><input type="radio" name="num" value="0.8">0.8</label>
      <label><input type="radio" name="num" value="0.9">0.9</label>
      <label><input type="radio" name="num" value="1.0">1.0</label>
    </div>

    <h3>保存</h3>
    <button id="exportBtn">エクスポート</button>
    <button id="importBtn">インポート</button>
    <textarea id="data"></textarea>
  </div>
</div>

<script>
const size=4;
let selected="";
let selectedNumber="0.5";
let selectedIsMulti=false;
const boards=[];
const dataEl=document.getElementById("data");
const exportBtn=document.getElementById("exportBtn");
const importBtn=document.getElementById("importBtn");

const connections={
  "━":{l:1,r:1,u:0,d:0},"┃":{l:0,r:0,u:1,d:1},
  "┗":{l:0,r:1,u:1,d:0},"┏":{l:0,r:1,u:0,d:1},
  "┓":{l:1,r:0,u:0,d:1},"┛":{l:1,r:0,u:1,d:0},
  "┳":{l:1,r:1,u:0,d:1},"┻":{l:1,r:1,u:1,d:0},
  "┣":{l:0,r:1,u:1,d:1},"┫":{l:1,r:0,u:1,d:1}
};
const partPos={top:[3,3],bottom:[0,3],glove:[3,0],shoes:[0,0]};

// 回路選択
document.querySelectorAll(".symbol").forEach(s=>{
  s.onclick=()=>{
    document.querySelectorAll(".symbol").forEach(x=>x.classList.remove("selected"));
    s.classList.add("selected");
    selected=s.textContent;
    selectedIsMulti = s.classList.contains("multi");
  };
});

// 数字選択
document.querySelectorAll('input[name="num"]').forEach(r=>{
  r.onchange=()=>{ selectedNumber=r.value; };
});

const boardsEl=document.getElementById("boards");

for(let i=0;i<4;i++){
  const wrap=document.createElement("div");
  wrap.className="board-wrap";

  const panel=document.createElement("div");
  panel.className="panel";
  panel.innerHTML=`
    <select class="color">
      <option value="red">赤</option>
      <option value="blue">青</option>
      <option value="green">緑</option>
    </select>
    <select class="part">
      <option value="">---</option>
      <option value="top">上衣</option>
      <option value="bottom">下衣</option>
      <option value="glove">手袋</option>
      <option value="shoes">靴</option>
    </select>
  `;
  wrap.appendChild(panel);

  const board=document.createElement("div");
  board.className="board";
  wrap.appendChild(board);

  const sumDiv=document.createElement("div");
  sumDiv.style.marginTop="6px";
  sumDiv.style.fontWeight="bold";
  sumDiv.textContent="接続済み合計: 0";
  wrap.appendChild(sumDiv);

  const grid=Array.from({length:4},()=>Array(4).fill(null).map(()=>({symbol:"",number:"",multi:false})));

  panel.querySelector(".part").onchange=()=>{
    for(let y=0;y<4;y++) for(let x=0;x<4;x++)
      grid[y][x]={symbol:grid[y][x].symbol==="◯"?"◯":"",number:grid[y][x].number,multi:grid[y][x].multi};
    const p=panel.querySelector(".part").value;
    if(p){
      const [x,y]=partPos[p];
      grid[y][x]={symbol:"◯",number:grid[y][x].number,multi:false};
    }
    draw();
  };
  panel.querySelector(".color").onchange=()=>draw();

  function draw(){
    board.querySelectorAll(".cell").forEach((c,i)=>{
      const y=Math.floor(i/4), x=i%4;
      const s=grid[y][x];
      c.innerHTML=`<div class="symbol-display">${s.symbol}</div><div class="number-display">${s.number||""}</div>`;
      c.className="cell";
      if(s.multi) c.classList.add("multi-cell");
    });
    update();
  }

  for(let y=0;y<4;y++) for(let x=0;x<4;x++){
    const c=document.createElement("div");
    c.className="cell";
    c.onclick=()=>{
      const cell=grid[y][x];
      if(cell.symbol==="◯") return;
      if(selected==="⌫"){
        grid[y][x]={symbol:"",number:"",multi:false}; // 数字も消す
      }
      else if(selected){
        grid[y][x]={
          symbol:selected,
          number: selectedIsMulti ? "" : (selectedNumber || cell.number || ""),
          multi: selectedIsMulti
        };
      }
      draw();
    };
    board.appendChild(c);
  }

  function update(){
    const dx={l:-1,r:1,u:0,d:0}, dy={l:0,r:0,u:-1,d:1}, opp={l:"r",r:"l",u:"d",d:"u"};
    let hasLine=false, circle=false;

    for(let y=0;y<4;y++) for(let x=0;x<4;x++){
      const s=grid[y][x];
      if(!s.symbol) continue;
      if(!connections[s.symbol] && s.symbol!=="◯") continue;
      if(s.symbol!=="◯") hasLine=true;
      if(s.symbol==="◯"){
        for(const d in dx){
          const nx=x+dx[d], ny=y+dy[d];
          if(grid[ny]?.[nx]?.symbol && grid[ny][nx].symbol!=="◯") circle=true;
        }
        continue;
      }
      for(const d in connections[s.symbol]){
        if(!connections[s.symbol][d]) continue;
        const nx=x+dx[d], ny=y+dy[d];
        const t=grid[ny]?.[nx];
        if(!t) return clear();
        if(t.symbol==="◯"){circle=true; continue;}
        if(!connections[t.symbol] || !connections[t.symbol][opp[d]]) return clear();
      }
    }

    const color=panel.querySelector(".color").value;
    let sum=0;

    board.querySelectorAll(".cell").forEach((c,i)=>{
      const y=Math.floor(i/4), x=i%4;
      const s=grid[y][x];
      c.className="cell";

      // 複セルは隣接数字セルを半分計算
      if(s.multi){
        let sumHalf=0;
        for(const d in dx){
          const nx=x+dx[d], ny=y+dy[d];
          const t=grid[ny]?.[nx];
          if(t && t.symbol && t.symbol!=="◯" && !t.multi && t.number){
            if(connections[s.symbol] && connections[t.symbol]){
              for(const dir in connections[s.symbol]){
                if(connections[s.symbol][dir]){
                  const tx=x+dx[dir], ty=y+dy[dir];
                  if(tx===nx && ty===ny && connections[t.symbol][opp[dir]]){
                    const n=parseFloat(t.number);
                    if(!isNaN(n)) sumHalf+=n/2;
                  }
                }
              }
            }
          }
        }
        c.querySelector(".number-display").textContent=sumHalf?sumHalf.toFixed(2):"";
      } else {
        c.querySelector(".number-display").textContent=s.number||"";
      }

      if(hasLine && circle && s.symbol && connections[s.symbol]){
        c.classList.add("connected","highlight-"+color);
        const n=parseFloat(c.querySelector(".number-display").textContent);
        if(!isNaN(n)) sum+=n;
      }
    });

    sumDiv.textContent="接続済み合計: "+sum.toFixed(2);
  }

  function clear(){board.querySelectorAll(".cell").forEach(c=>c.className="cell");}

  boards.push({grid,panel,draw});
  boardsEl.appendChild(wrap);
}

// 保存/読み込み
exportBtn.onclick=()=>{
  dataEl.value=JSON.stringify(
    boards.map(b=>({
      grid:b.grid.map(r=>r.map(c=>({symbol:c.symbol,number:c.number,multi:c.multi}))),
      color:b.panel.querySelector(".color").value,
      part:b.panel.querySelector(".part").value
    })), null, 2
  );
};

importBtn.onclick=()=>{
  try{
    const data=JSON.parse(dataEl.value);
    data.forEach((d,i)=>{
      for(let y=0;y<4;y++) for(let x=0;x<4;x++){
        boards[i].grid[y][x]={symbol:d.grid[y][x].symbol, number:d.grid[y][x].number, multi:d.grid[y][x].multi};
      }
      boards[i].panel.querySelector(".color").value=d.color;
      boards[i].panel.querySelector(".part").value=d.part;
      boards[i].draw();
    });
  } catch{ alert("データ形式が不正です"); }
};
</script>
</body>
</html>
